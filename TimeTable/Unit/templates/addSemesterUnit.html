{% extends "base.html" %}

{% block title %}Add Semester Units{% endblock title %}

{% block body %}

    This is the add semester unit page
    ## Drag and Drop

    <style>
        #palette, #canvas {
            float: left;
            width: 45%;
            height: 300px;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px;
            overflow: auto;
        }
        .draggable-unit {
            width: 200px;
            height: 35px;
            margin: 5px;
            padding: 5px;
            border: 1px solid black;
            cursor: move;
            position: relative;
            display: flex;
            justify-content: space-between;
        }
        .delete-button {
            cursor: pointer;
            color: red;
        }
        .popup-wrapper {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.5); /* Semi-transparent black background */
            width: 100%;
            height: 100%;
        }
        .popup {
            background: white;
            padding: 20px;
            max-width: 400px;
            margin: 100px auto;
            border-radius: 8px;
            position: relative;
        }
        .popup-close {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }
    </style>
    <script>
        var addedToCanvas = new Set();
        var draggedUnitId;
        function allowDrop(ev) {
            ev.preventDefault();
        }
        function drag(ev) {
            ev.dataTransfer.setData("text", ev.target.id);
            draggedUnitId = event.target.id;
            event.dataTransfer.setData("text", draggedUnitId);
        }
        function closePopup() {
            var popup = document.querySelector('.popup-wrapper');
            popup.style.display = 'none';
        }
        function drop(ev) {
            ev.preventDefault();
            var data = ev.dataTransfer.getData("text");
            var draggedElement = document.getElementById(data);
            if (ev.target.id !== draggedElement.parentNode.id && !addedToCanvas.has(data)) {
                var clonedElement = draggedElement.cloneNode(true);
                clonedElement.removeAttribute("draggable");
                clonedElement.setAttribute('data-unit-id', data);
                ev.target.appendChild(clonedElement);
                addedToCanvas.add(data);
                var deleteButton = document.createElement("span");
                deleteButton.className = "delete-button";
                deleteButton.innerHTML = "ðŸ—‘ï¸";;
                deleteButton.onclick = function () {
                    ev.target.removeChild(clonedElement);     // Remove the element from the canvas and update the set
                    addedToCanvas.delete(data);
                };
                clonedElement.appendChild(deleteButton);
                closePopup();
                var popup = document.querySelector('.popup-wrapper')
                popup.style.display = 'block';
                var popupform = popup.querySelector('.popup-content');
                var selectform = popupform.querySelector('#id_Lecturer');
                var saveBtn = popupform.querySelector('#popup-save-btn');
                if (saveBtn !== null){
                    popupform.removeChild(saveBtn);
                }
                var departmentId = draggedElement.dataset.departmentId;
                var url = "{% url 'Unit:GetLecturers-View' department_id=9999999999 %}";
                url = url.replace("9999999999", departmentId);
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        const lecturers = JSON.parse(data);
                        // Clear previous options
                        selectform.innerHTML = "";
                        // Add new options
                        lecturers.forEach(lecturer => {
                            var option = document.createElement("option");
                            option.value = lecturer.pk;  // Assuming the id is in the 'fields' object
                            option.text = lecturer.fields.username;  // Change this based on your field names
                            selectform.appendChild(option);
                        });
                    });
            }
        }
        function linkUnitLecBtn() {
            var selectedLecturerId = document.getElementById('id_Lecturer').value;
            var clonedElement = document.querySelector('.draggable-unit[data-unit-id]:last-child');
            if (draggedUnitId && selectedLecturerId && clonedElement) {
                console.log(`Linking Unit ${draggedUnitId} with Lecturer ${selectedLecturerId}`);
                clonedElement.setAttribute('data-lec-id', selectedLecturerId);
                closePopup();
            } else {
                console.error("Dragged unit ID or selected lecturer ID is missing.");
            }
        }
        function collectSemesterUnitData() {
            var semesterUnits = [];
            var canvasElements = document.querySelectorAll('#canvas .draggable-unit[data-unit-id][data-lec-id]');
            canvasElements.forEach(element => {
                var unitId = element.getAttribute('data-unit-id');
                var lecturerId = element.getAttribute('data-lec-id');
                semesterUnits.push({ unitId: unitId, lecturerId: lecturerId });
            });
            console.log("SemesterUnits is: ",semesterUnits)
            return semesterUnits;
        }
        function getCSRFToken() {
            var csrfToken = null;
            document.cookie.split(';').forEach(cookie => {
                var parts = cookie.trim().split('=');
                if (parts[0] === 'csrftoken') {
                    csrfToken = decodeURIComponent(parts[1]);
                }
            });
            return csrfToken;
        }
        function saveSemesterUnits(){
            var semesterUnits = collectSemesterUnitData();
            var csrfToken = document.querySelector('input[name=csrfmiddlewaretoken]');
            if (semesterUnits.length > 0){
                // Make an AJAX request to the backend
                var url = "{% url 'Unit:SaveSemesterUnit-View' %}";
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCSRFToken(),
                    },
                    body: JSON.stringify({ semesterUnits: semesterUnits }),
                })
                .then(response => response.json())
                .then(data => {
                    // Handle the response from the backend
                    if (data.success) {
                        alert('SemesterUnits saved successfully!');
                        // Redirect or perform other actions on success
                        window.location.href = "{% url 'Unit:SemesterUnit-View' %}";
                    } else {
                        alert('Error saving SemesterUnits: ' + data.error);
                        // Handle error response
                    }
                })
                .catch(error => {
                    console.error('Error saving SemesterUnits:', error);
                    // Handle fetch error
                });
            }else{
                alert('No SemesterUnits to save.');
            }
        }
    </script>
    <h2>Drag and Drop</h2>
    <p>Drag units from the palette to the canvas.</p>
    <!-- Palette -->
    <div id="palette" ondrop="drop(event)" ondragover="allowDrop(event)">
        {% for unit in units %}
            <div class="draggable-unit" draggable="true" ondragstart="drag(event)" id="{{ unit.id }}" data-department-id="{{ unit.Department.id }}">{{ unit.name }}</div>
        {% endfor %}
    </div>
    <!-- Canvas -->
    <div id="canvas" ondrop="drop(event)" ondragover="allowDrop(event)"></div>
    <div class="popup-wrapper">
        <div class="popup">
            <div class="popup-close">X</div>
            <div class="popup-content">
                <h1>Select Lecturer</h1>
                <label for="id_Lecturer">Lecturer:</label>
                <select name="Lecturer" id="id_Lecturer" required></select>
                <button id="linkLecturerBtn" onclick="linkUnitLecBtn()">Link lec</button>
            </div>
        </div>
    </div>
    </div>
    <button onclick="saveSemesterUnits()">Submit</button>

{% endblock body %}